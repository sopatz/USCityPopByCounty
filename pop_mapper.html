<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>US County Map with Cities</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        /* Make it so map spans entire screen */
        #map {
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        // Initialize the map centered in the US
        var map = L.map('map').setView([37.8, -96], 4);

        let cityData = [];
        let cityMarkers = L.layerGroup().addTo(map); // Store city markers globally

        // Add base tile layer from OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Load counties GeoJSON
        fetch("county_data.geojson")
            .then(response => response.json())
            .then(countyData => {
                L.geoJSON(countyData, {
                    style: { color: "#555", weight: 1, fillOpacity: 0.3 },
                    onEachFeature: function (feature, layer) {
                        let countyName = feature.properties.coty_name[0];
                        let stateName = feature.properties.ste_name[0];
                        let countyFIPS = feature.properties.coty_fp_code; //for dealing with the names of Alaskan county equivalents
                        layer.on('click', function (e) {
                            showCitiesPopup(countyName, stateName, countyFIPS, e.latlng);
                            console.log(countyName); console.log(stateName); console.log(countyFIPS);
                        });
                    }
                }).addTo(map);
            });

        // Load city population JSON
        fetch("city_population.json")
            .then(response => response.json())
            .then(data => {
                cityData = data;
            });

        function showCitiesPopup(countyName, stateName, countyFIPS, latlng) {
            // Clear existing markers
            cityMarkers.clearLayers();

            // Filter cities that belong to the selected county
            let cities = cityData
                .filter(city => city.county_name === countyName && city.state_name === stateName)
                .sort((a, b) => b.population - a.population) // Sort by population (descending)
                .slice(0, 5) // Get top 5 most populous cities
                //.map(city => `${city.city} (${city.population.toLocaleString()})`);

            // Add markers for each city
            cities.forEach(city => {
                let marker = L.marker([city.lat, city.lng])
                    .bindPopup(`<b>${city.city}</b><br>Population: ${city.population.toLocaleString()}`)
                    .addTo(cityMarkers);
            });

            // Show popup with city list
            let cityList = cities.map(city => `${city.city} (${city.population.toLocaleString()})`);

            // Dealing with county equivalent names
            let county = "County"
            if (stateName === "Louisiana") {
                county = "Parish"
            }
            else if (stateName === "Alaska") {
                if (countyFIPS === "013" || // Aleutians East Borough
                    countyFIPS === "060" || // Bristol Bay Borough
                    countyFIPS === "068" || // Denali Borough
                    countyFIPS === "090" || // Fairbanks North Star Borough
                    countyFIPS === "100" || // Haines Borough
                    countyFIPS === "122" || // Kenai Peninsula Borough
                    countyFIPS === "130" || // Ketchikan Gateway Borough
                    countyFIPS === "150" || // Kodiak Island Borough
                    countyFIPS === "164" || // Lake and Peninsula Borough
                    countyFIPS === "170" || // Matanuska-Susitna Borough
                    countyFIPS === "185" || // North Slope Borough
                    countyFIPS === "188" || // Northwest Arctic Borough
                    countyFIPS === "195") { // Petersburg Borough
                        county = "Borough"
                }
                else if (countyFIPS === "110" || // Juneau City and Borough
                         countyFIPS === "220" || // Sitka City and Borough
                         countyFIPS === "275" || // Wrangell City and Borough
                         countyFIPS === "282") { // Yakutat City and Borough
                            county = "City and Borough"
                }
                else if (countyFIPS === "020" || // Anchorage Municipality
                         countyFIPS === "230") { // Skagway Municipality
                            county = "Municipality"
                }
                else if (countyFIPS === "016" || // Aleutians West Census Area
                         countyFIPS === "050" || // Bethel Census Area
                         countyFIPS === "063" || // Chucagh Census Area
                         countyFIPS === "066" || // Copper River Census Area
                         countyFIPS === "070" || // Dillingham Census Area
                         countyFIPS === "105" || // Hoonah-Angoon Census Area
                         countyFIPS === "158" || // Kusilvak Census Area
                         countyFIPS === "180" || // Nome Census Area
                         countyFIPS === "198" || // Prince of Wales-Hyder Census Area
                         countyFIPS === "240" || // Southeast Fairbanks Census Area
                         countyFIPS === "290") { // Yukon-Koyukuk Census Area
                            county = "Census Area"
                }
            }
            L.popup()
                .setLatLng(latlng)
                .setContent(`<b>${countyName} ${county}, ${stateName}</b><br>${cityList.join("<br>") || "No data available"}`)
                .openOn(map);
        }
    </script>
</body>
</html>
