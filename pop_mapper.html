<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>US County Map with Cities</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        /* Make it so map spans entire screen */
        #map {
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        // Initialize the map centered in the US
        var map = L.map('map').setView([37.8, -96], 4);

        let cityData = [];
        let cityMarkers = L.layerGroup().addTo(map); // Store city markers globally

        // State FIPS Code to State Name mapping
        const stateFIPSMap = {
            "01": "Alabama", "02": "Alaska", "04": "Arizona", "05": "Arkansas", "06": "California",
            "08": "Colorado", "09": "Connecticut", "10": "Delaware", "11": "District of Columbia",
            "12": "Florida", "13": "Georgia", "15": "Hawaii", "16": "Idaho", "17": "Illinois",
            "18": "Indiana", "19": "Iowa", "20": "Kansas", "21": "Kentucky", "22": "Louisiana",
            "23": "Maine", "24": "Maryland", "25": "Massachusetts", "26": "Michigan",
            "27": "Minnesota", "28": "Mississippi", "29": "Missouri", "30": "Montana",
            "31": "Nebraska", "32": "Nevada", "33": "New Hampshire", "34": "New Jersey",
            "35": "New Mexico", "36": "New York", "37": "North Carolina", "38": "North Dakota",
            "39": "Ohio", "40": "Oklahoma", "41": "Oregon", "42": "Pennsylvania",
            "44": "Rhode Island", "45": "South Carolina", "46": "South Dakota",
            "47": "Tennessee", "48": "Texas", "49": "Utah", "50": "Vermont",
            "51": "Virginia", "53": "Washington", "54": "West Virginia",
            "55": "Wisconsin", "56": "Wyoming"
        };

        // Add base tile layer from OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Load counties GeoJSON
        fetch("counties.geojson")
            .then(response => response.json())
            .then(countyData => {
                L.geoJSON(countyData, {
                    style: { color: "#555", weight: 1, fillOpacity: 0.3 },
                    onEachFeature: function (feature, layer) {
                        let countyName = feature.properties.NAME;
                        let stateFIPS = feature.properties.STATEFP;
                        let stateName = stateFIPSMap[stateFIPS];
                        layer.on('click', function (e) {
                            showCitiesPopup(countyName, stateName, e.latlng);
                        });
                    }
                }).addTo(map);
            });

        // Load city population JSON
        fetch("city_population.json")
            .then(response => response.json())
            .then(data => {
                cityData = data;
            });

        function showCitiesPopup(countyName, stateName, latlng) {
            // Clear existing markers
            cityMarkers.clearLayers();

            // Filter cities that belong to the selected county
            let cities = cityData
                .filter(city => city.county_name === countyName && city.state_name === stateName)
                .sort((a, b) => b.population - a.population) // Sort by population (descending)
                .slice(0, 5) // Get top 5 most populous cities
                //.map(city => `${city.city} (${city.population.toLocaleString()})`);

            // Add markers for each city
            cities.forEach(city => {
                let marker = L.marker([city.lat, city.lng])
                    .bindPopup(`<b>${city.city}</b><br>Population: ${city.population.toLocaleString()}`)
                    .addTo(cityMarkers);
            });

            // Show popup with city list
            let cityList = cities.map(city => `${city.city} (${city.population.toLocaleString()})`);
            L.popup()
                .setLatLng(latlng)
                .setContent(`<b>${countyName} County, ${stateName}</b><br>${cityList.join("<br>") || "No data available"}`)
                .openOn(map);
        }
    </script>
</body>
</html>
