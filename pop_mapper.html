<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>US County Map with Cities</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        /* Make it so map spans entire screen */
        #map {
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        // Initialize the map centered in the US
        var map = L.map('map').setView([37.8, -96], 4);

        let cityData = [];
        let cityMarkers = L.layerGroup().addTo(map); // Store city markers globally

        // Add base tile layer from OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Load counties GeoJSON
        fetch("county_data.geojson")
            .then(response => response.json())
            .then(countyData => {
                L.geoJSON(countyData, {
                    style: { color: "#555", weight: 1, fillOpacity: 0.3 },
                    onEachFeature: function (feature, layer) {
                        let countyName = feature.properties.coty_name[0];
                        let stateName = feature.properties.ste_name[0];
                        let countyType = feature.properties.coty_type; //for dealing with county-equivalents
                        let countyFIPS = feature.properties.coty_code[0]; //to deal with cases of two county-equivalents in the same state having the same name (Franklin, Virginia, e.g.)
                        layer.on('click', function (e) {
                            showCitiesPopup(countyName, stateName, countyType, countyFIPS, e.latlng);
                            console.log(countyName); console.log(stateName); console.log(countyType); console.log(countyFIPS); //for debugging purposes
                        });
                    }
                }).addTo(map);
            });

        // Load city population JSON
        fetch("city_population.json")
            .then(response => response.json())
            .then(data => {
                cityData = data;
            });

        function showCitiesPopup(countyName, stateName, countyType, countyFIPS, latlng) {
            // Clear existing markers
            cityMarkers.clearLayers();

            // Filter cities that belong to the selected county
            let cities = cityData
                .filter(city => city.county_name === countyName && city.state_name === stateName && city.county_fips == countyFIPS)
                .sort((a, b) => b.population - a.population) // Sort by population (descending)
                .slice(0, 5) // Get top 5 most populous cities
                //.map(city => `${city.city} (${city.population.toLocaleString()})`);

            // Add markers for each city
            cities.forEach(city => {
                let marker = L.marker([city.lat, city.lng])
                    .bindPopup(`<b>${city.city}</b><br>Population: ${city.population.toLocaleString()}`)
                    .addTo(cityMarkers);
            });

            // Show popup with city list
            let cityList = cities.map(city => `${city.city} (${city.population.toLocaleString()})`);

            // Dealing with county-equivalent names
            let fullCountyName = countyName;
            if (countyType === "county") {
                fullCountyName += " County";
            }
            else if (countyType === "municipality" || countyType === "municipio") {
                fullCountyName += " Municipality";
            }
            else if (countyType === "borough") {
                fullCountyName += " Borough"
            }
            else if (countyType === "census area") {
                fullCountyName += " Census Area";
            }
            else if (countyType === "city and borough") {
                fullCountyName += " City and Borough"
            }
            else if (countyType === "city") {
                fullCountyName = "City of " + fullCountyName;
            }
            else if (countyType === "district") {
                fullCountyName += " District";
            }
            else if (countyType === "island") {
                fullCountyName += " Island";
            }
            else if (countyType === null && stateName === "Connecticut") {
                fullCountyName += " Planning Region";
            }

            L.popup()
                .setLatLng(latlng)
                .setContent(`<b>${fullCountyName}, ${stateName}</b><br>${cityList.join("<br>") || "No data available"}`)
                .openOn(map);
        }
    </script>
</body>
</html>
